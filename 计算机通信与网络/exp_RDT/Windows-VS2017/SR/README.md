# SR 协议实现 (Selective Repeat Protocol)

## 协议概述

这是一个基于 C++ 实现的 Selective Repeat (SR) 可靠数据传输协议。SR 协议是一种改进的滑动窗口协议，能够单独确认和重传丢失的分组，相比 GBN 协议具有更高的传输效率。

## 主要特性

- **选择性重传**：只重传真正丢失的分组
- **独立确认**：每个分组都有独立的确认机制
- **接收方窗口**：接收方也维护滑动窗口，可以乱序接收分组
- **独立计时器**：每个已发送但未确认的分组都有独立的超时计时器
- **序列号管理**：使用固定大小的序列号空间（默认为 8）

## 文件结构

```
SR/
├── SR.cpp                 # 主程序入口
├── SRRdtSender.h          # 发送方类声明
├── SRRdtSender.cpp        # 发送方实现
├── SRRdtReceiver.h        # 接收方类声明
├── SRRdtReceiver.cpp      # 接收方实现
├── DataStructure.h        # 数据包结构定义
├── RdtSender.h            # 发送方接口
├── RdtReceiver.h          # 接收方接口
└── input.txt              # 测试输入数据
```

## 核心类说明

### SRRdtSender (发送方)
- **选择性重传**：只为丢失的分组启动重传
- **独立计时器**：每个分组都有独立的超时计时器
- **窗口管理**：维护发送窗口，跟踪每个分组的状态
- **缓冲区状态**：记录每个序列号分组的确认状态

### SRRdtReceiver (接收方)
- **乱序接收**：可以接收并缓存乱序到达的分组
- **选择性确认**：为每个正确接收的分组发送确认
- **按序交付**：确保向上层按顺序交付数据
- **接收窗口**：维护接收窗口管理乱序分组

## 配置参数

- **窗口大小**：默认为 4 个分组
- **序列号空间**：默认为 8（3 位序列号）
- **超时时间**：在 Configuration 中配置

## 编译和运行

### 环境要求
- Visual Studio 2017 或更高版本
- Windows 操作系统

### 编译步骤
1. 打开解决方案文件 (.sln)
2. 选择编译配置 (Debug/Release)
3. 编译项目

### 运行程序
程序会自动：
- 从 `input.txt` 读取输入数据
- 执行 SR 协议传输
- 将结果输出到 `output.txt`
- 在控制台显示详细的传输过程

## 输出说明

### 控制台输出
程序提供两种运行模式：
- **VERBOSE 模式**：显示详细的传输过程和状态信息
- **安静模式**：只显示关键信息

控制台输出包括：
- 发送方和接收方的状态变化
- 滑动窗口的可视化显示
- 分组发送、接收和确认的详细信息
- 超时和选择性重传事件

### 滑动窗口显示格式
发送方窗口：
```
[ [ 0* 1> 2 3 ] - - - - ] (base=0, nextSeq=2, 窗口大小=4)
```
- `[ ]` 表示窗口边界
- `>` 标记下一个要发送的序列号
- `*` 标记已确认的序列号
- `-` 表示不在窗口内的序列号
- 括号内显示当前窗口参数

接收方窗口：
```
[ [ 0* 1 2* 3 ] - - - - ] (base=0, 窗口大小=4)
```
- `*` 标记已缓存的序列号

## 实现细节

### 发送方逻辑
1. 上层应用调用 `send()` 发送数据
2. 如果窗口未满，将数据封装为分组并发送
3. 为每个分组启动独立的计时器
4. 收到确认后，标记对应分组为已确认状态
5. 移动窗口基序号到第一个未确认的分组
6. 超时只重传对应的单个分组

### 接收方逻辑
1. 检查接收到的分组校验和
2. 如果分组在接收窗口内且正确，发送确认并缓存
3. 如果分组是期望的基序号，交付给上层并移动窗口
4. 如果分组乱序但正确，缓存并发送确认
5. 如果分组损坏或窗口外，发送否定确认

## 与 GBN 协议的区别

| 特性       | GBN 协议         | SR 协议                    |
| ---------- | ---------------- | -------------------------- |
| 重传机制   | 回退 N 步重传    | 选择性重传                 |
| 接收方窗口 | 大小为 1         | 大小与发送方相同           |
| 确认机制   | 累积确认         | 独立确认                   |
| 计时器     | 单个计时器       | 每个分组独立计时器         |
| 缓冲区     | 发送方需要缓冲区 | 发送方和接收方都需要缓冲区 |

## 测试和验证

程序包含完整的错误处理机制，可以测试以下场景：
- 正常的数据传输
- 单个分组丢失
- 多个分组丢失
- 分组损坏
- 确认丢失
- 乱序到达
- 超时重传

## 扩展和自定义

可以通过修改以下参数来调整协议行为：
- 在 `SRRdtSender` 和 `SRRdtReceiver` 构造函数中修改窗口大小和序列号空间
- 在 `Configuration` 中调整超时时间
- 修改输入输出文件路径

## 注意事项

- 确保输入文件存在且格式正确
- 序列号空间应大于等于窗口大小的两倍
- 程序使用模拟网络环境，不涉及真实网络通信
- SR 协议需要更多的内存来维护分组状态和计时器

## 性能优势

相比 GBN 协议，SR 协议在以下场景中表现更好：
- 高丢包率网络环境
- 长延迟网络
- 需要高吞吐量的应用
